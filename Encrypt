for i, bot in pairs(getBots()) do
    if getBot().name:upper() == bot.name:upper() then
        pcallBot = i
    end
end

initialize = {}
local customizable = {
    index = 1,
    indexDrop = 1,
    indexTake = 1,
    tileX = 0,
    param = 0,
    initX = posX - 1,
    initY = posY - 1
}

customizable.notifications = function(desc)
    messageBox = MessageBox.new()
    messageBox.title = "Caramoy Syndicate"
    messageBox.description = desc
    messageBox:send()
end

customizable.randomLetter = function()
    local withnum = "ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789"
    local generate = ""
    for i = 1,10 do
        local randomnumber = math.random(1,#withnum)
        local acaknomor = string.sub(withnum,randomnumber,randomnumber)
        generate = generate..acaknomor
    end
    return generate
end

customizable.split = function(str, ptr)
    if not ptr then 
        ptr = "%s"
    end
    local tbl = {}
    for string in string.gmatch(str, ptr) do
        table.insert(tbl, string) 
    end
    return tbl
end

customizable.initBot = function()
    if getBot().status == BotStatus.online then
        return "Online"
    elseif getBot().status == BotStatus.account_banned  then
        return "Suspended"
    elseif getBot().status == BotStatus.error_connecting  then
        return "Ercon"
    elseif getBot().status == BotStatus.maintenance then
        return "Maintenance"
    elseif getBot().status == BotStatus.changing_subserver then
        return "Changing Subserver"
    elseif getBot().status == BotStatus.location_banned then
        return "Location Banned"
    else
        return "Disconnect"
    end
end

customizable.initStatus = function()
    str = ""
    for _, bot in pairs(getBots()) do
        str = str.."\n["..bot.level.."]||"..string.upper(bot.name).."||" 
    end
    return str
end

customizable.initWorld = function()
    str = ""
    for _, bots in pairs(getBots()) do
        str = str.."\n||"..string.upper(bots:getWorld().name).."||" 
    end
    return str
end

customizable.initOnStorage = function()
    str = ""
    for i = 1, #storagetake do
        local world = customizable.split(storagetake[i],"[^|]+")[1]
        str = str.."\n||"..world.."|| : "..(initialize[world] or "?")..""
    end
    return str
end

customizable.initOutStorage = function()
    str = ""
    for i = 1, #storagedrop do
        local world = customizable.split(storagedrop[i],"[^|]+")[1]
        str = str.."\n||"..world.."|| : "..(initialize[world] or "?")..""
    end
    return str
end

customizable.itemFloat = function(id)
    return getBot():getWorld().growscan:getObjects()[id] or 0
end

customizable.initializeBots = function()
	if linkbotinfo ~= "x" then
        local webhook = Webhook.new(linkbotinfo)
        webhook.embed1.use = true
        webhook.embed1.title = "Caramoy Syndicate [https://discord.com/invite/fTTKW8vvuq]"
        webhook.embed1.color = math.random(111111,999999)
        webhook.embed1:addField("World Take",customizable.initOnStorage(),true)
        webhook.embed1:addField("World Drop",customizable.initOutStorage(),true)
        webhook.embed1.footer.text = "[Lucifer] : Move WTW Script\nLast update : "..(os.date("!%a %b %d, %Y at %I:%M %p", os.time() + 7 * 60 * 60))..""
        webhook:edit(messageidbotinfo)
    end
end

customizable.botStatics = function(text,execution)
    if webhookstatuslink ~= "x"  then
        local webhook = Webhook.new(webhookstatuslink)
        webhook.content = "@everyone"
        webhook.embed1.use = true
        webhook.embed1:addField("",text,false)
        webhook.embed1.footer.text = execution
        webhook:send()
    end
end

customizable.reconnect = function(world,id,x,y)
    if getBot().status == BotStatus.online and getBot():getPing() == 0 then
        getBot():disconnect()
        sleep(2000)
    end
    if not getBot():isInWorld(world:upper()) or getBot().status ~= BotStatus.online then
        customizable.botStatics(""..getBot().name.." status is "..customizable.initBot().." Current : "..getBot():getWorld().name.."","Status Script : Running")
        while getBot().status ~= BotStatus.online do
            getBot():connect()
            if getBot().status == BotStatus.account_banned then
                customizable.botStatics(""..getBot().name.." status is "..customizable.initBot().."","Status Script : Stopped, Reason : Bot status "..customizable.initBot().."")
                getBot():stopScript()
            end
            if getBot().status == BotStatus.maintenance then
                sleep(delaymaintenance * 60000)
            else
                sleep(delayreconnect * 1000)
            end
        end
        while not getBot():isInWorld(world:upper()) do
            getBot():warp(world:upper())
            sleep(delaywarp * 1000)
        end
        if id ~= "" then
            while getTile(getBot().x,getBot().y).fg == 6 do
                getBot():warp(world:upper(),id:upper())
                sleep(delaywarp * 1000)
            end
        end
        if x and y then
            while getBot().x ~= x or getBot().y ~= y do
                getBot():findPath(x,y)
                sleep(150)
            end
        end
        customizable.botStatics(""..getBot().name.." status is "..customizable.initBot().." Current : "..getBot():getWorld().name.."","Status Script : Running")
    end
end

customizable.warp = function(world,door)
    name = world
    if door ~= "" then
        name = name .. "|" ..door
    end
    if not getBot():isInWorld(world:upper()) then
        local count = 0
        addEvent(Event.variantlist, function(variant, netid)
            if variant:get(0):getString() == "OnConsoleMessage" then
                if variant:get(1):getString():lower():find("inaccessible.") or variant:get(1):getString():lower():find("unknown reason.") then
                    nuked = true
                end
            end
        end)
        while not getBot():isInWorld(world:upper()) and not nuked do
            if getBot().status == BotStatus.online and getBot():getPing() == 0 then
                getBot():disconnect()
                sleep(2000)
            end
            if getBot().status ~= BotStatus.online then
                customizable.botStatics(""..getBot().name.." status is "..customizable.initBot().."","Status Script : Running")
                while getBot().status ~= BotStatus.online do
                    getBot():connect()
                    if getBot().status == BotStatus.account_banned then
                        customizable.botStatics(""..getBot().name.." status is "..customizable.initBot().."","Status Script : Stopped, Reason : Bot status "..customizable.initBot().."")
                        getBot():stopScript()
                    end
                    if getBot().status == BotStatus.maintenance then
                        sleep(delaymaintenance * 60000)
                    else
                        sleep(delayreconnect * 1000)
                    end
                end
                customizable.botStatics(""..getBot().name.." status is "..customizable.initBot().."","Status Script : Running")
            end
            getBot():warp(name)
            listenEvents(delaywarp)
            count = count + 1
            if count == 5 then
                count = 0
                customizable.botStatics(""..getBot().name.." : Maybe hard warp?, disconnecting bot and sleeping for "..delayidiotserver.." minutes","Status Script : Running")
                getBot():disconnect()
                sleep(delayidiotserver * 60000)
            end
        end
        removeEvents()
        sleep(1000)
    end
    if getBot():isInWorld(world:upper()) then
        if door ~= "" then
            local stuck = 0
            while getTile(getBot().x,getBot().y).fg == 6 and not wrong do
                if getBot().status == BotStatus.online and getBot():getPing() == 0 then
                    getBot():disconnect()
                    sleep(2000)
                end
                if getBot().status ~= BotStatus.online then
                    customizable.botStatics(""..getBot().name.." status is "..customizable.initBot().."","Status Script : Running")
                    while getBot().status ~= BotStatus.online do
                        getBot():connect()
                        if getBot().status == BotStatus.account_banned then
                            customizable.botStatics(""..getBot().name.." status is "..customizable.initBot().."","Status Script : Stopped, Reason : Bot status "..customizable.initBot().."")
                            getBot():stopScript()
                        end
                        if getBot().status == BotStatus.maintenance then
                            sleep(delaymaintenance * 60000)
                        else
                            sleep(delayreconnect * 1000)
                        end
                    end
                    customizable.botStatics(""..getBot().name.." status is "..customizable.initBot().."","Status Script : Running")
                end
                getBot():warp(name)
                sleep(delaywarp * 1000)
                stuck = stuck + 1
                if stuck == 5 then
                    wrong = true
                end
            end
        end
    end
end

customizable.floatDetect = function(x,y)
    local count = 0
    local stack = 0
    for _,obj in pairs(getBot():getWorld():getObjects()) do
        if math.floor(obj.x / 32) == x and math.floor(obj.y / 32) == y then
            count = count + obj.count
            stack = stack + 1
        end
    end
    if stack >= 1 then
        return true
    end
    return false
end

customizable.onStoring = function()
    for i = customizable.indexDrop , #storagedrop do
        print("["..pcallBot.."]Dropping items")
        getBot().auto_collect = false
        world = customizable.split(storagedrop[i],"[^|]+")[1]
        door = customizable.split(storagedrop[i],"[^|]+")[2]
        customizable.warp(world,door)
        customizable.initializeBots()
        if not nuked then
            if not wrong then
                if customizable.itemFloat(itemId[1]) >= limit then
                    initialize[world] = ""..customizable.itemFloat(itemId[1]).."x (LIMIT)"
                    customizable.botStatics("Drop storage : ||"..world.."|| has reached limit, skipped world","Status Script : Running")
                    print("["..pcallBot.."]Drop storage : "..world.."  has reached limit, skipped world")
                    customizable.indexDrop = customizable.indexDrop + 1
                    customizable.tileX = 0
                    if customizable.indexDrop > #storagedrop then
                        initialize[world] = ""..customizable.itemFloat(itemId[1]).."x (LIMIT)"
                        customizable.botStatics("All drop storage has reached limit","Status Script : Stopped, Reason : All drop storage is limit")
                        customizable.initializeBots()
                        if removingbot then
                            removeBot()
                            sleep(2000)
                        else
                            customizable.warp(customizable.randomLetter(),"")
                        end
                        customizable.notifications("["..pcallBot.."]All drop storage has reached limit")
                        getBot():stopScript()
                    end
                else
                    for y,pack in pairs(itemId) do
                        for i,tile in pairs(getBot():getWorld():getTiles()) do
                            if separated then
                                if #itemId == 1 then
                                    if tile.fg == 0 or tile.bg == 0 then
                                        ::BACK::
                                        getBot():findPath(customizable.initX + (customizable.tileX),customizable.initY)
                                        sleep(100)
                                        customizable.reconnect(world,door,customizable.initX + (customizable.tileX),customizable.initY)
                                        if customizable.initX + (customizable.tileX) >= 98 then
                                            customizable.initY = customizable.initY - 1
                                            customizable.tileX = 0
                                        end
                                        if customizable.floatDetect(getBot().x -1, getBot().y) then
                                            customizable.tileX = customizable.tileX + 1
                                            goto BACK
                                        end
                                        while getBot():getInventory():getItemCount(pack) > 0 do
                                            getBot():setDirection(true)
                                            sleep(100)
                                            getBot():drop(pack,200)
                                            sleep(delaydrop * 1000)
                                            customizable.reconnect(world,door,customizable.initX + (customizable.tileX),customizable.initY)
                                        end
                                    end
                                else
                                    if tile.fg == 0 or tile.bg == 0 then
                                        ::BACK::
                                        getBot():findPath(customizable.initX + (customizable.tileX),customizable.initY - (y-1))
                                        sleep(100)
                                        local count = 0
                                        customizable.reconnect(world,door,customizable.initX + (customizable.tileX),customizable.initY - (y-1))
                                        if customizable.initX + (customizable.tileX) >= 98 then
                                            customizable.initY = customizable.initY - #itemId
                                            customizable.tileX = 0
                                        end
                                        if customizable.floatDetect(getBot().x - 1, getBot().y) then
                                            customizable.tileX = customizable.tileX + 1
                                            goto BACK
                                        end
                                        while getBot():getInventory():getItemCount(pack) > 0 do
                                            getBot():setDirection(true)
                                            sleep(100)
                                            getBot():drop(pack,200)
                                            sleep(delaydrop * 1000)
                                            customizable.reconnect(world,door,customizable.initX + (customizable.tileX),customizable.initY - (y-1))
                                        end
                                    end
                                end
                            else
                                if tile.fg == 0 or tile.bg == 0 then
                                    ::BACK::
                                    getBot():findPath(customizable.initX + (customizable.tileX),customizable.initY)
                                    sleep(100)
                                    local count = 0
                                    customizable.reconnect(world,door,customizable.initX + (customizable.tileX),customizable.initY)
                                    if customizable.initX + (customizable.tileX) >= 98 then
                                        customizable.initY = customizable.initY - 1
                                        customizable.tileX = 0
                                    end
                                    while getBot():getInventory():getItemCount(pack) > 0 do
                                        getBot():setDirection(true)
                                        sleep(100)
                                        getBot():drop(pack,200)
                                        sleep(delaydrop * 1000)
                                        customizable.reconnect(world,door,customizable.initX + (customizable.tileX),customizable.initY)
                                        count = count + 1
                                        if count >= 2 then
                                            customizable.tileX = customizable.tileX + 1
                                            goto BACK
                                        end
                                    end
                                end
                            end
                            if getBot():getInventory():getItemCount(pack) == 0 then
                                break
                            end
                        end
                    end
                    sleep(100)
                    break
                end
            else
                initialize[world] = "WRONG DOOR"
                wrong = false
                print("["..pcallBot.."]("..world..") Id door drop storage is wrong, check ur id door!")
                customizable.botStatics("||"..world.."|| Id door drop storage is wrong, check ur id door!","Status Script : Running")
                customizable.indexDrop = customizable.indexDrop + 1
                customizable.tileX = 0
                if customizable.indexDrop > #storagedrop then
                    customizable.botStatics("All drop storage has reached limit!","Status Script : Stopped, Reason : All drop storage is limit")
                    if removingbot then
                        removeBot()
                        sleep(2000)
                    else
                        customizable.warp(customizable.randomLetter(),"")
                    end
                    customizable.initializeBots()
                    customizable.notifications("["..pcallBot.."]All drop storage has reached limit")
                    getBot():stopScript()
                end
            end
        else
            initialize[world] = "NUKED"
            nuked = false
            print("["..pcallBot.."]("..world..") drop Storage is NUKED, check ur storage!")
            customizable.botStatics("||"..world.."|| drop Storage is NUKED, check ur storage!","Status Script : Running")
            customizable.indexDrop = customizable.indexDrop + 1
            customizable.tileX = 0
            if customizable.indexDrop > #storagedrop then
                customizable.botStatics("All drop storage has reached limit!","Status Script : Stopped, All drop storage is limit")
                if removingbot then
                    removeBot()
                    sleep(2000)
                else
                    customizable.warp(customizable.randomLetter(),"")
                end
                customizable.initializeBots()
                customizable.notifications("["..pcallBot.."]All drop storage has reached limit!")
                getBot():stopScript()
            end
        end
    end
    initialize[world] = ""..customizable.itemFloat(itemId[1]).."x"
    customizable.onTake()
end

customizable.onTake = function()
    ::back::
    for i = customizable.indexTake, #storagetake do
        print("["..pcallBot.."]Taking items")
        world = customizable.split(storagetake[i],"[^|]+")[1]
        door = customizable.split(storagetake[i],"[^|]+")[2]
        customizable.warp(world,door)
        customizable.initializeBots()
        if not nuked then
            if not wrong then
                if customizable.itemFloat(itemId[1]) < amountTake then
                    initialize[world] = ""..customizable.itemFloat(itemId[1]).."x (More less than amount take)"
                    customizable.botStatics("Take storage : ||"..world.."|| has empty, skipped world","Status Script : Running")
                    print("["..pcallBot.."]Take storage : ("..world..") has empty, skipped world")
                    if not looping then
                        customizable.indexTake = customizable.indexTake + 1
                        if customizable.indexTake > #storagetake then
                            initialize[world] = ""..customizable.itemFloat(itemId[1]).."x (More less than amount take)"
                            customizable.botStatics("All take storage has empty","Status Script : Stopped, Reason : All storage take is empty")
                            customizable.initializeBots()
                            if removingbot then
                                removeBot()
                                sleep(2000)
                            else
                                customizable.warp(customizable.randomLetter(),"")
                            end
                            customizable.notifications("["..pcallBot.."]All take storage has empty")
                            getBot():stopScript()
                        end
                    else
                        if #storagetake == 1 then
                            sleep(delaylooping * 1000)
                            goto back
                        else
                            sleep(delaylooping * 1000)
                            customizable.indexTake = customizable.indexTake + 1
                            if customizable.indexTake > #storagetake then
                                customizable.indexTake = 1
                                goto back
                            end
                        end
                    end
                else
                    for _, pack in pairs(itemId) do
                        local count = 0
                        while getBot():getInventory():getItemCount(pack) < amountTake do
                            for _, object in pairs(getBot():getWorld():getObjects()) do
                                if object.id == pack then
                                    getBot():findPath(math.floor((object.x)/32), math.floor((object.y)/32))
                                    sleep(100)
                                    getBot():collect(3)
                                    sleep(500)
                                    customizable.reconnect(world,door,math.floor((object.x)/32), math.floor((object.y)/32))
                                    break
                                end
                            end
                            if getBot():getInventory():getItemCount(pack) >= amountTake then
                                break
                            else
                                count = count + 1
                                if count == 3 then
                                    break
                                end
                            end
                        end
                    end
                    sleep(100)
                    break
                end
            else
                initialize[world] = "WRONG DOOR"
                wrong = false
                print("["..pcallBot.."]("..world..") Id door take storage is wrong, check ur id door!")
                customizable.botStatics("||"..world.."|| Id door take storage is wrong, check ur id door!","Status Script : Running")
                customizable.indexTake = customizable.indexTake + 1
                if customizable.indexTake > #storagetake then
                    customizable.botStatics("All take storage has empty!","Status Script : Stopped, Reason : All storage take is empty")
                    if removingbot then
                        removeBot()
                        sleep(2000)
                    else
                        customizable.warp(customizable.randomLetter(),"")
                    end
                    customizable.initializeBots()
                    customizable.notifications("["..pcallBot.."]All take storage has empty")
                    getBot():stopScript()
                end
            end
        else
            initialize[world] = "NUKED"
            nuked = false
            print("["..pcallBot.."]("..world..") take Storage is NUKED, check ur storage!")
            customizable.botStatics("||"..world.."|| take Storage is NUKED, check ur storage!","Status Script : Running")
            customizable.indexTake = customizable.indexTake + 1
            if customizable.indexTake > #storagetake then
                customizable.botStatics("All take storage has empty!","Status Script : Stopped, Reason : All take storage is empty")
                if removingbot then
                    removeBot()
                    sleep(2000)
                else
                    customizable.warp(customizable.randomLetter(),"")
                end
                customizable.initializeBots()
                customizable.notifications("["..pcallBot.."]All take storage has empty!")
                getBot():stopScript()
            end
        end
    end
    initialize[world] = ""..customizable.itemFloat(itemId[1]).."x"
    customizable.onStoring()
end

customizable.detectTable = function(items,amt)
    for _, init in pairs(items) do
        if getBot():getInventory():getItemCount(init) >= amt then
            return true
        end
    end
    return false
end

if Information == "Script Move WTW made by Caramoy Syndicate, Link Server : https://discord.com/invite/fTTKW8vvuq" and scriptVersion == "0.2" then
    getBot().auto_reconnect = false
    while getBot().status ~= BotStatus.online do
        getBot():connect()
        sleep(delayreconnect * 1000)
    end
    sleep(pcallBot * delayexecute * 1000)
    if customizable.detectTable(itemId,amountTake) then
        customizable.onStoring()
    else
        customizable.onTake()
    end
else
    customizable.botStatics("Script Move WTW made by Caramoy Syndicate, Link Server : https://discord.com/invite/fTTKW8vvuq","Status Script : Stopped, Reason : Reseller idiot")
    customizable.notifications("["..pcallBot.."]Script Move WTW made by Caramoy Syndicate, Link Server : https://discord.com/invite/fTTKW8vvuq")
end
